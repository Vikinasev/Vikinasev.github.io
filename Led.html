<!DOCTYPE html>
<html>
<head>
	<title>My First Value</title>
	<link rel="stylesheet" href="Led.css">
	<script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.js" type="text/javascript"></script>

</head>
<body>
	<h1><div id="connstatus">Mqtt Not connected.</div></h1>

	<div class="text-box">
    	<a id="mqttButton" href="#" class="btn btn-white btn-animate">On</a>
	</div>

	<div id="lamp"></div>

	<script>
		var websocket = "a0dcde1a548d471dbb80aa751dbf3c9d.s1.eu.hivemq.cloud";
		var port = 8884;
		var user = "viktor";
		var pass = "ViktorNasev04";
		var buttonState = false;

		function toggleButtonState() {
			buttonState = !buttonState;

			var message = new Paho.MQTT.Message(buttonState ? '1' : '0');
			message.destinationName = 'control/led';
			client.send(message);
		}

		client = new Paho.MQTT.Client(websocket, port, "Deviceid_34534543");
		client.onConnectionLost = onConnectionLost;
		client.onMessageArrived = onMessageArrived;

		var options = {
			useSSL: true,
			userName: user,
			password: pass,
			onSuccess: onConnect,
			onFailure: doFail
		};

		client.connect(options);

		function onConnect() {
			document.getElementById("connstatus").innerHTML = "Mqtt Connected";
			console.log("Mqtt Connected");
			client.subscribe("control/led");
			document.getElementById('mqttButton').addEventListener('click', toggleButtonState);
		}

		function doFail(e) {
			console.log(e);
		}

		function onConnectionLost(responseObject) {
			document.getElementById("connstatus").innerHTML = "Mqtt Not Connected";

			if (responseObject.errorCode !== 0) {
				console.log("onConnectionLost: " + responseObject.errorMessage);
			}
		}

		function onMessageArrived(message) {
			console.log("onMessageArrived: " + message.destinationName);
			console.log("message.payloadString: " + message.payloadString);

			if (message.destinationName === "control/led") {
				var statusValue = message.payloadString;

				if (statusValue === "0") {
					buttonState = false; // Изключваме
				} else if (statusValue === "1") {
					buttonState = true; // Включваме
				}

				updateButtonState();
				updateLampState();
			}
		}

		function updateButtonState() {
			var buttonText = buttonState ? "Off" : "On";
			document.getElementById("mqttButton").innerHTML = buttonText;
			document.getElementById("mqttButton").classList.toggle("on", !buttonState);
		}

		function updateLampState() {
			var lampElement = document.getElementById("lamp");
			lampElement.classList.toggle("on", buttonState);
		}
	</script>
</body>
</html>
